(()=>{function E(){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#main").hide(),$("#swapForm").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),D(),$("#error").text(""),$("#btnSwap").prop("disabled",!0),$("#btnSwap").text("Transfer"),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),$("#btnSwapSpinnerText").hide(),O()}function I(){D(),k(),$("#steps").hide(),O(),$("#error").text("")}function k(){$("#btnSwap").hide(),$("#btnSwapSpinner").prop("disabled",!0),$("#btnSwapSpinner").show(),$("#btnSwapSpinnerText").show(),$("#workflow").show(),$("#close").hide()}function D(){$("#txSummary1Label").text(""),$("#txSummary1").hide(),$("#txSummary2Label").text(""),$("#txSummary2").hide(),$("#txSummary3Label").text(""),$("#txSummary3").hide(),$("#txSummary4Label").text(""),$("#txSummary4").hide(),$("#txSummary5Label").text(""),$("#txSummary5").hide(),$("#txSummary6Label").text(""),$("#txSummary6").hide()}function O(){$("#ethDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").removeClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active"),$("#archethicDeploymentStep").removeClass("is-failed"),$("#swapStep").removeClass("is-active"),$("#swapStep").removeClass("is-failed")}async function b(e){return new Promise(function(t,r){e.status>=200&&e.status<=299?e.json().then(t):e.json().then(r).catch(()=>r(e.statusText))})}var F=[];for(let e=0;e<=255;++e){let t=e.toString(16).padStart(2,"0");F.push(t)}function L(e){let t=new Uint8Array(e),r=new Array(t.length);for(let n=0;n<t.length;++n)r[n]=F[t[n]];return r.join("")}function B(e,t){switch($("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),console.error(e.message||e),$("#error").text(`${e.message||e}`).show(),$("#close").show(),t){case 1:$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").addClass("is-failed"),$("#archethicDeploymentStep").addClass("is-failed"),$("#swapStep").addClass("is-failed");break;case 2:$("#ethTransferStep").addClass("is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;case 3:$("#archethicDeploymentStep").addClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed");break;case 4:$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed"),$("#archethicDeploymentStep").removeClass("is-active is-failed"),$("#swapStep").addClass("is-failed"),$("#swapStep").removeClass("is-active");break;default:break}}function U(e){switch(e){case 80001:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Mumbai Polygon Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 137:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Polygon"),$("#toNetworkLabel").text("Archethic");break;case 97:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 56:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC"),$("#toNetworkLabel").text("Archethic");break;case 5:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Goerli Ethereum Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 1337:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum Devnet"),$("#toNetworkLabel").text("Archethic Devnet");break;default:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum"),$("#toNetworkLabel").text("Archethic");break}return $("#sourceChainImg").attr("src",`assets/images/bc-logos/${sourceChainLogo}`),fromChainName}async function _(e,t){let r=await Q();return new ethers.Contract(e,r,t)}async function P(e,t){let{abi:r}=await V();return new ethers.Contract(e,r,t)}async function M(e,t,r,n,c,i){let{abi:o,bytecode:s}=await V(),d=await new ethers.ContractFactory(o,s,c).deploy(e,t,ethers.utils.parseUnits(r,18),n,i,{gasLimit:1e6}),l=await d.deployTransaction.wait();return console.log(l),console.log("HTLC contract deployed at "+d.address),{contract:d,transaction:l}}async function G(e,t,r,n){return await(await r.connect(n).transfer(t,ethers.utils.parseUnits(e,18))).wait()}async function J(e){let{HTLC_Contract:t,amount:r,unirisContract:n,signer:c,sourceChainExplorer:i}=e;$("#ethTransferStep").addClass("is-active");let o=await G(r,t.address,n,c);localStorage.setItem("transferStep","transferedERC20");let s=localStorage.getItem("pendingTransfer"),a=JSON.parse(s);return a.erc20transferAddress=o.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(a)),console.log(`${r} UCO transfered`),$("#txSummary2Label").html(`Provision UCO: <a href="${i}/tx/${o.transactionHash}" target="_blank">${o.transactionHash}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),e.erc20transferAddress=o.transactionHash,e}async function R(e){let{HTLC_Contract:t,amount:r,secretDigestHex:n,recipientArchethic:c,ethChainId:i,toChainExplorer:o,HTLC_transaction:s}=e;$("#archethicDeploymentStep").addClass("is-active"),step=3;let a=await X(n,c,r,t.address,s.transactionHash,i);localStorage.setItem("transferStep","deployedArchethicContract");let d=localStorage.getItem("pendingTransfer"),l=JSON.parse(d);return l.archethicContractAddress=a,localStorage.setItem("pendingTransfer",JSON.stringify(l)),console.log("Contract address on Archethic",a),$("#txSummary3Label").html(`Contract address on Archethic: <a href="${o}/${a}" target="_blank">${a}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),e.archethicContractAddress=a,e}async function j(e){let{HTLC_Contract:t,signer:r,secretHex:n,unirisContract:c,UCOPrice:i,sourceChainExplorer:o}=e,s=await z(t,r,n);localStorage.setItem("transferStep","withdrawEthContract");let a=localStorage.getItem("pendingTransfer"),d=JSON.parse(a);d.withdrawEthereumAddress=s.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(d)),console.log(`Ethereum's withdraw transaction - ${s.transactionHash}`),$("#txSummary4Label").html(`${fromChainName} swap: <a href="${o}/tx/${s.transactionHash}" target="_blank">${s.transactionHash}</a>`),$("#txSummary4").show();let l=await r.getAddress(),m=await c.balanceOf(l),p=ethers.utils.formatUnits(m,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(p).toFixed(2)));let g=20/i;return $("#maxUCOValue").text(Math.min(p/i,g).toFixed(5)),$("#fromBalanceUSD").text((p*i).toFixed(5)),e.withdrawEthereumAddress=s.transactionHash,e}async function W({archethicContractAddress:e,HTLC_Contract:t,withdrawEthereumAddress:r,secretHex:n,ethChainId:c,toChainExplorer:i}){console.log(e);let{archethicWithdrawTransaction:o,archethicTransferTransaction:s}=await K(e,t.address,r,n,c);localStorage.setItem("transferStep","withdrawArchethicContract"),console.log(`Archethic's withdraw transaction ${o}`),console.log(`Archethic's transfer transaction ${s}`),$("#txSummary5Label").html(`Archethic swap: <a href="${i}/${o}" target="_blank">${o}</a>`),$("#txSummary5").show(),$("#txSummary6Label").html(`Archethic transfer: <a href="${i}/${s}" target="_blank">${s}</a>`),$("#txSummary6").show()}async function X(e,t,r,n,c,i){let o=new Date;o.setSeconds(o.getSeconds()+1e4);let s=Math.floor(o/1e3);return fetch("/swap/deployContract",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({secretHash:e,recipientAddress:t,amount:r*1e8,endTime:s,ethereumContractAddress:n,ethereumContractTransaction:c,ethereumChainId:i})}).then(b).then(a=>a.contractAddress)}async function z(e,t,r){return await(await(await e.connect(t)).withdraw(`0x${r}`,{gasLimit:1e7})).wait()}async function K(e,t,r,n,c){return fetch("/swap/withdraw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({archethicContractAddress:e,ethereumContractAddress:t,ethereumWithdrawTransaction:r,secret:n,ethereumChainId:c})}).then(b).then(i=>{let{archethicWithdrawTransaction:o,archethicTransferTransaction:s}=i;return{archethicWithdrawTransaction:o,archethicTransferTransaction:s}})}async function Q(){return await(await fetch("uco_abi.json")).json()}async function V(){let t=await(await fetch("HTLC.json")).json();return{abi:t.abi,bytecode:t.bytecode}}async function A(e){return fetch(`/balances/archethic/${e}`).then(b).then(t=>t.balance)}async function H(e){return fetch("/status",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ethereumChainId:e})}).then(b).then(t=>{if(t.status!="ok")throw t.status;return{archethicEndpoint:t.archethicEndpoint,unirisTokenAddress:t.unirisTokenAddress,recipientEthereum:t.recipientEthereum,sufficientFunds:t.sufficientFunds,UCOPrice:t.UCOPrice,sourceChainExplorer:t.sourceChainExplorer,bridgeAddress:t.bridgeAddress}})}var C;window.onload=async function(){try{if(typeof window.ethereum<"u")console.log("MetaMask is installed!"),C=new ethers.providers.Web3Provider(window.ethereum),localStorage.getItem("walletInjected?")&&($("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),await C.send("eth_requestAccounts",[]),q());else throw"No ethereum provider is installed"}catch(e){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#connectMetamaskBtn").prop("disabled",!0),$("#connectionError").text(e.message||e).show()}};$("#connectMetamaskBtn").on("click",async()=>{try{$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),await C.send("eth_requestAccounts",[]),localStorage.setItem("walletInjected?",!0),await q()}catch(e){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#connectionError").text(`${e.message||e}`).show()}});var N,x,w;async function q(){let{chainId:e}=await C.getNetwork(),t=C.getSigner();console.log(C.provider),C.provider.on("chainChanged",h=>console.log("chain updated "+h));let r=U(e);console.log(r);let{archethicEndpoint:n,unirisTokenAddress:c,recipientEthereum:i,sufficientFunds:o,UCOPrice:s,sourceChainExplorer:a,bridgeAddress:d}=await H(e);w=s,E();let l=(20/s).toFixed(5);if($("#nbTokensToSwap").attr("max",l),N=`${n}/explorer/transaction`,$("#ucoPrice").text(`1 UCO = ${s.toFixed(5)}$`).show(),$("#swapBalanceUSD").text(0),!o){$("#error").text("Bridge has insuffficient funds. Please retry later...");return}console.log("Archethic endpoint: ",n);let m=await t.getAddress();m.length>4?accountStr=m.substring(0,5)+"..."+m.substring(m.length-3):accountStr=m,$("#accountName").html(`Account<br><a href="${a}/address/${m}" target="_blank">${accountStr}</a>`);let p=await _(c,C),g=await p.balanceOf(m),f=ethers.utils.formatUnits(g,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(f).toFixed(8))),$("#maxUCOValue").attr("value",Math.min(f,l).toFixed(5)),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((f*s).toFixed(5))),setInterval(async()=>{let{UCOPrice:h}=await H(e);if(h!=w){$("#ucoPrice").text(`1 UCO = ${h.toFixed(5)}$`).show();let S=(20/h).toFixed(5);$("#nbTokensToSwap").attr("max",S),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((f*h).toFixed(5))),$("#maxUCOValue").attr("value",Math.min(f,S).toFixed(5)),w=h}},5e3),$("#recipientAddress").on("change",async h=>{let T=await A($(h.target).val())/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(T).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((w*T).toFixed(5))),$("#btnSwap").prop("disabled",!1)}),$("#recipientAddress").focus(),$("#nbTokensToSwap").on("input",h=>{let S=$(h.target).val();$("#swapBalanceUSD").text((S*w).toFixed(5))}),$("#maxButton").on("click",()=>{let h=$("#maxUCOValue").val();$("#nbTokensToSwap").val(h),$("#swapBalanceUSD").text((h*w).toFixed(5))}),$("#close").on("click",()=>{$("#workflow").hide()});let y=localStorage.getItem("pendingTransfer"),u;y&&(u=await Z(y,e,p,a,N,i,t,r)),$("#swapForm").on("submit",async h=>{if(h.preventDefault(),!h.target.checkValidity())return;if($("#error").text(""),u){k();try{await v(localStorage.getItem("transferStep"),u)}catch(T){B(T,x)}return}let S=$("#recipientAddress").val();await Y(t,p,i,S,e,s,a,d,r,f)})}async function Y(e,t,r,n,c,i,o,s,a,d){I(),x=0;let l=$("#nbTokensToSwap").val();if(d*1e18<l*1e18){$("#btnSwapSpinner").hide(),$("#btnSwap").show(),$("#btnSwap").prop("disabled",!1),$("#error").text(`Insufficient UCO on ${a}`),$("#close").show();return}if(await A(s)<=l*1e8){$("#error").text("Bridge has insuffficient funds. Please retry later..."),$("#close").show();return}$("#steps").show();let p=new Uint8Array(32);crypto.getRandomValues(p);let g=L(p),f=await crypto.subtle.digest("SHA-256",p);f=new Uint8Array(f);let y=L(f);$("#ethDeploymentStep").addClass("is-active"),x=1;try{let{contract:u,transaction:h}=await M(r,t.address,l,f,e,7200);localStorage.setItem("pendingTransfer",JSON.stringify({HTLC_Address:u.address,secretHex:g,secretDigestHex:y,amount:l,recipientArchethic:n,HTLC_transaction:h})),localStorage.setItem("transferStep","deployedEthContract"),$("#ethDeploymentStep").removeClass("is-active");let S=u.address;$("#txSummary1Label").html(`Contract address on ${a}: <a href="${o}/address/${u.address}" target="_blank">${u.address}</a>`),$("#txSummary1").show(),await v("deployedEthContract",{HTLC_Contract:u,secretHex:g,secretDigestHex:y,amount:l,ethChainId:c,recipientEthereum:r,recipientArchethic:n,unirisContract:t,signer:e,sourceChainExplorer:o,toChainExplorer:N,HTLC_transaction:h})}catch(u){B(u,x)}}async function v(e,t){switch(e){case"deployedEthContract":return e=2,t=await J(t),await v("transferedERC20",t);case"transferedERC20":return e=3,t=await R(t),await v("deployedArchethicContract",t);case"deployedArchethicContract":return e=4,$("#swapStep").addClass("is-active"),t=await j(t),await v("withdrawEthContract",t);case"withdrawEthContract":await W(t),$("#swapStep").removeClass("is-active"),$("#btnSwapSpinner").hide(),$("#btnSwap").prop("disabled",!1),$("#btnSwap").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#close").show(),console.log("Token swap finish"),localStorage.removeItem("transferStep"),localStorage.removeItem("pendingTransfer"),setTimeout(async()=>{let n=await A(t.recipientArchethic)/1e8;$("#toBalanceUCO").text(parseFloat(n).toFixed(2)),$("#toBalanceUSD").text((w*n).toFixed(5))},2e3);break}}async function Z(e,t,r,n,c,i,o,s){$("#btnSwapSpinnerText").text("Loading previous transfer"),$("#btnSwapSpinner").show(),$("#btnSwap").hide();let a=JSON.parse(e),d={HTLC_Contract:await P(a.HTLC_Address,C),HTLC_transaction:a.HTLC_transaction,secretHex:a.secretHex,secretDigestHex:a.secretDigestHex,amount:a.amount,ethChainId:t,recipientEthereum:i,recipientArchethic:a.recipientArchethic,unirisContract:r,signer:o,erc20transferAddress:a.erc20transferAddress,archethicContractAddress:a.archethicContractAddress,withdrawEthereumAddress:a.withdrawEthereumAddress,sourceChainExplorer:n,toChainExplorer:c};$("#recipientAddress").val(a.recipientArchethic),$("#nbTokensToSwap").val(a.amount);let m=await A(a.recipientArchethic)/1e8;switch($("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(m).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((w*m).toFixed(5))),$("#swapBalanceUSD").text((a.amount*w).toFixed(5)),$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#txSummary1Label").html(`Contract address on ${s}: <a href="${n}/address/${a.HTLC_Address}" target="_blank">${a.HTLC_Address}</a>`),$("#txSummary1").show(),$("#ethTransferStep").addClass("is-active"),x=2,a.erc20transferAddress&&(x=3,$("#txSummary2Label").html(`Provision UCO: <a href="${n}/tx/${a.erc20transferAddress}" target="_blank">${a.erc20transferAddress}</a>`),$("#txSummary2").show()),a.archethicContractAddress&&(x=4,$("#txSummary3Label").html(`Contract address on Archethic: <a href="${c}/${a.archethicContractAddress}" target="_blank">${a.archethicContractAddress}</a>`),$("#txSummary3").show()),a.withdrawEthereumAddress&&($("#txSummary4Label").html(`${s} swap: <a href="${n}/tx/${a.withdrawEthereumAddress}" target="_blank">${a.withdrawEthereumAddress}</a>`),$("#txSummary4").show()),$("#btnSwapSpinner").hide(),$("#btnSwap").show(),$("#btnSwap").prop("disabled",!1),x){case 2:$("#ethTransferStep").addClass("is-active"),$("#ethTransferStep").removeClass("is-failed"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;case 3:$("#archethicDeploymentStep").addClass("is-active"),$("#archethicDeploymentStep").removeClass("is-failed"),$("#ethDeploymentStep").removeClass("is-failed is-active"),$("#ethTransferStep").removeClass("is-failed is-active");break;case 4:$("#swapStep").addClass("is-active"),$("#swapStep").removeClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;default:break}return $("#steps").show(),d}})();
//# sourceMappingURL=app.js.map
