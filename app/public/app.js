(()=>{function N(){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#main").hide(),$("#swapForm").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),E(),$("#error").text(""),$("#btnSwap").prop("disabled",!0),$("#btnSwap").text("Transfer"),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),$("#btnSwapSpinnerText").hide(),T()}function B(){E(),q(),$("#steps").hide(),T(),$("#error").text("")}function q(){$("#btnSwap").hide(),$("#btnSwapSpinner").prop("disabled",!0),$("#btnSwapSpinner").show(),$("#btnSwapSpinnerText").show()}function E(){$("#txSummary1Label").text(""),$("#txSummary1").hide(),$("#txSummary2Label").text(""),$("#txSummary2").hide(),$("#txSummary3Label").text(""),$("#txSummary3").hide(),$("#txSummary4Label").text(""),$("#txSummary4").hide(),$("#txSummary5Label").text(""),$("#txSummary5").hide()}function T(){$("#ethDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").removeClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active"),$("#archethicDeploymentStep").removeClass("is-failed"),$("#swapStep").removeClass("is-active"),$("#swapStep").removeClass("is-failed")}async function g(e){return new Promise(function(t,a){e.status>=200&&e.status<=299?e.json().then(t):e.json().then(a).catch(()=>a(e.statusText))})}var I=[];for(let e=0;e<=255;++e){let t=e.toString(16).padStart(2,"0");I.push(t)}function L(e){let t=new Uint8Array(e),a=new Array(t.length);for(let n=0;n<t.length;++n)a[n]=I[t[n]];return a.join("")}function k(e,t){switch($("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),console.error(e.message||e),$("#error").text(`${e.message||e}`).show(),console.log(t),t){case 1:$("#ethDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").addClass("is-failed"),$("#ethTransferStep").addClass("is-failed");break;case 2:$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").addClass("is-failed");break;case 3:$("#archethicDeploymentStep").removeClass("is-active"),$("#archethicDeploymentStep").addClass("is-failed");break;case 4:$("#swapStep").removeClass("is-active"),$("#swapStep").addClass("is-failed");break;default:break}}function D(e){switch(e){case 80001:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Mumbai Polygon Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 137:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Polygon"),$("#toNetworkLabel").text("Archethic");break;case 97:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 56:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC"),$("#toNetworkLabel").text("Archethic");break;case 5:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Goerli Ethereum Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 1337:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum Devnet"),$("#toNetworkLabel").text("Archethic Devnet");break;default:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum"),$("#toNetworkLabel").text("Archethic");break}return $("#sourceChainImg").attr("src",`assets/images/bc-logos/${sourceChainLogo}`),fromChainName}async function O(e,t){let a=await Q();return new ethers.Contract(e,a,t)}async function F(e,t){let{abi:a}=await j();return new ethers.Contract(e,a,t)}async function U(e,t,a,n,i,c){let{abi:o,bytecode:h}=await j(),d=await new ethers.ContractFactory(o,h,i).deploy(e,t,ethers.utils.parseUnits(a,18),n,c,{gasLimit:1e6}),l=await d.deployTransaction.wait();return console.log(l),console.log("HTLC contract deployed at "+d.address),{contract:d,transaction:l}}async function G(e,t,a,n){return await(await a.connect(n).transfer(t,ethers.utils.parseUnits(e,18))).wait()}async function _(e){let{HTLC_Contract:t,amount:a,unirisContract:n,signer:i,sourceChainExplorer:c}=e;$("#ethTransferStep").addClass("is-active");let o=await G(a,t.address,n,i);localStorage.setItem("transferStep","transferedERC20");let h=localStorage.getItem("pendingTransfer"),s=JSON.parse(h);return s.erc20transferAddress=o.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(s)),console.log(`${a} UCO transfered`),$("#txSummary2Label").html(`Provision UCO: <a href="${c}/tx/${o.transactionHash}" target="_blank">${o.transactionHash}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),e.erc20transferAddress=o.transactionHash,e}async function P(e){let{HTLC_Contract:t,amount:a,secretDigestHex:n,recipientArchethic:i,ethChainId:c,toChainExplorer:o,HTLC_transaction:h}=e;$("#archethicDeploymentStep").addClass("is-active"),step=3;let s=await X(n,i,a,t.address,h.transactionHash,c);localStorage.setItem("transferStep","deployedArchethicContract");let d=localStorage.getItem("pendingTransfer"),l=JSON.parse(d);return l.archethicContractAddress=s,localStorage.setItem("pendingTransfer",JSON.stringify(l)),console.log("Contract address on Archethic",s),$("#txSummary3Label").html(`Contract address on Archethic : <a href="${o}/${s}" target="_blank">${s}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),e.archethicContractAddress=s,e}async function J(e){let{HTLC_Contract:t,signer:a,secretHex:n,unirisContract:i,UCOPrice:c,sourceChainExplorer:o}=e,h=await z(t,a,n);localStorage.setItem("transferStep","withdrawEthContract");let s=localStorage.getItem("pendingTransfer"),d=JSON.parse(s);d.withdrawEthereumAddress=h.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(d)),console.log(`Ethereum's withdraw transaction - ${h.transactionHash}`),$("#txSummary4Label").html(`${fromChainName} swap: <a href="${o}/tx/${h.transactionHash}" target="_blank">${h.transactionHash}</a>`),$("#txSummary4").show();let l=await a.getAddress(),x=await i.balanceOf(l),p=ethers.utils.formatUnits(x,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(p).toFixed(2)));let u=20/c;return $("#maxUCOValue").text(Math.min(p/c,u).toFixed(5)),$("#fromBalanceUSD").text(p*c),e.withdrawEthereumAddress=h.transactionHash,e}async function R({archethicContractAddress:e,HTLC_Contract:t,withdrawEthereumAddress:a,secretHex:n,ethChainId:i,toChainExplorer:c}){console.log(e);let o=await K(e,t.address,a,n,i);localStorage.setItem("transferStep","withdrawArchethicContract"),console.log(`Archethic's withdraw transaction ${o}`),$("#txSummary5Label").html(`Archethic swap : <a href="${c}/${o}" target="_blank">${o}</a>`),$("#txSummary5").show()}async function X(e,t,a,n,i,c){let o=new Date;o.setSeconds(o.getSeconds()+1e4);let h=Math.floor(o/1e3);return fetch("/swap/deployContract",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({secretHash:e,recipientAddress:t,amount:a*1e8,endTime:h,ethereumContractAddress:n,ethereumContractTransaction:i,ethereumChainId:c})}).then(g).then(s=>s.contractAddress)}async function z(e,t,a){return await(await(await e.connect(t)).withdraw(`0x${a}`,{gasLimit:1e7})).wait()}async function K(e,t,a,n,i){return fetch("/swap/withdraw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({archethicContractAddress:e,ethereumContractAddress:t,ethereumWithdrawTransaction:a,secret:n,ethereumChainId:i})}).then(g).then(c=>{let{archethicWithdrawTransaction:o}=c;return o})}async function Q(){return await(await fetch("uco_abi.json")).json()}async function j(){let t=await(await fetch("HTLC.json")).json();return{abi:t.abi,bytecode:t.bytecode}}async function b(e){return fetch(`/balances/archethic/${e}`).then(g).then(t=>t.balance)}async function M(e){return fetch("/status",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ethereumChainId:e})}).then(g).then(t=>{if(t.status!="ok")throw t.status;return{archethicEndpoint:t.archethicEndpoint,unirisTokenAddress:t.unirisTokenAddress,recipientEthereum:t.recipientEthereum,sufficientFunds:t.sufficientFunds,UCOPrice:t.UCOPrice,sourceChainExplorer:t.sourceChainExplorer,bridgeAddress:t.bridgeAddress}})}window.onload=async function(){if(localStorage.removeItem("transferStep"),localStorage.removeItem("pendingTransfer"),typeof window.ethereum<"u")console.log("MetaMask is installed!");else throw"No ethereum provider is installed"};$("#connectMetamaskBtn").on("click",async()=>{try{$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),provider=new ethers.providers.Web3Provider(window.ethereum),await provider.send("eth_requestAccounts",[]),await Y(provider)}catch(e){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#error").text(`${e.message||e}`).show()}});var v;var A;async function Y(e){let{chainId:t}=await e.getNetwork(),a=e.getSigner(),n=D(t);console.log(n);let{archethicEndpoint:i,unirisTokenAddress:c,recipientEthereum:o,sufficientFunds:h,UCOPrice:s,sourceChainExplorer:d,bridgeAddress:l}=await M(t);N();let x=20/s;if($("#nbTokensToSwap").attr("max",x),v=`${i}/explorer/transaction`,$("#ucoPrice").text(`1 UCO = ${s.toFixed(5)}$`).show(),$("#swapBalanceUSD").text(0),!h){$("#error").text("Bridge has insuffficient funds. Please retry later...");return}console.log("Archethic endpoint: ",i);let p=await a.getAddress(),u=await O(c,e),C=await u.balanceOf(p),S=ethers.utils.formatUnits(C,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(S).toFixed(8))),$("#maxUCOValue").attr("value",Math.min(S/s,x).toFixed(5)),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((S*s).toFixed(5))),$("#recipientAddress").on("change",async r=>{let w=await b($(r.target).val())/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(w).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((s*w).toFixed(5))),$("#btnSwap").prop("disabled",!1)}),$("#recipientAddress").focus(),$("#nbTokensToSwap").on("input",r=>{let f=$(r.target).val();$("#swapBalanceUSD").text((f*s).toFixed(5))}),$("#maxButton").on("click",()=>{let r=$("#maxUCOValue").val();$("#nbTokensToSwap").val(r),$("#swapBalanceUSD").text((r*s).toFixed(5))}),$(document).ready(function(){$("#email-form").submit(function(r){r.preventDefault();var f=$("#message").val();$.ajax({type:"POST",url:"/send-email",data:{message:f},success:function(w){alert("Email envoy\xE9 avec succ\xE8s !")},error:function(w){console.log(w)}})})});let m=localStorage.getItem("pendingTransfer");if(m){T(),$("#btnSwapSpinnerText").text("Loading previous transfer"),$("#btnSwapSpinner").show(),$("#btnSwap").hide();let r=JSON.parse(m),f={HTLC_Contract:await F(r.HTLC_Address,e),HTLC_transaction:r.HTLC_transaction,secretHex:r.secretHex,secretDigestHex:r.secretDigestHex,amount:r.amount,UCOPrice:s,ethChainId:t,recipientEthereum:o,recipientArchethic:r.recipientArchethic,unirisContract:u,signer:a,erc20transferAddress:r.erc20transferAddress,archethicContractAddress:r.archethicContractAddress,withdrawEthereumAddress:r.withdrawEthereumAddress,sourceChainExplorer:d,toChainExplorer:v};$("#recipientAddress").val(r.recipientArchethic),$("#nbTokensToSwap").val(r.amount);let H=await b(r.recipientArchethic)/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(H).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((s*H).toFixed(5))),$("#swapBalanceUSD").text((r.amount*s).toFixed(5)),$("#steps").show(),$("#ethDeploymentStep").removeClass("is-active"),$("#txSummary1Label").html(`Contract address on ${n}: <a href="${d}/address/${r.HTLC_Address}" target="_blank">${r.HTLC_Address}</a>`),$("#txSummary1").show(),$("#ethTransferStep").addClass("is-active"),A=2,r.erc20transferAddress&&(A=3,$("#txSummary2Label").html(`Provision UCO: <a href="${d}/tx/${r.erc20transferAddress}" target="_blank">${r.erc20transferAddress}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),$("#archethicDeploymentStep").addClass("is-active")),r.archethicContractAddress&&(A=4,$("#txSummary3Label").html(`Contract address on Archethic : <a href="${v}/${r.archethicContractAddress}" target="_blank">${r.archethicContractAddress}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),$("#swapStep").addClass("is-active")),r.withdrawEthereumAddress&&($("#txSummary4Label").html(`${n} swap: <a href="${d}/tx/${r.withdrawEthereumAddress}" target="_blank">${r.withdrawEthereumAddress}</a>`),$("#txSummary4").show(),$("#swapStep").removeClass("is-active")),$("#btnSwapSpinner").hide(),$("#btnSwap").show(),$("#btnSwap").prop("disabled",!1),$("#swapForm").off(),$("#swapForm").on("submit",async W=>{W.preventDefault(),changeBtnToTransferInProgress();try{await y(localStorage.getItem("transferStep"),f,s)}catch(V){k(V,A)}});return}$("#swapForm").on("submit",async r=>{if(r.preventDefault(),!r.target.checkValidity())return;let f=$("#recipientAddress").val();await Z(a,u,o,f,t,s,d,l,n)})}async function Z(e,t,a,n,i,c,o,h,s){B();var d=0;let l=$("#nbTokensToSwap").val();if(await b(h)<=l*1e9){$("#error").text("Bridge has insuffficient funds. Please retry later...");return}$("#steps").show();let p=new Uint8Array(32);crypto.getRandomValues(p);let u=L(p),C=await crypto.subtle.digest("SHA-256",p);C=new Uint8Array(C);let S=L(C);$("#ethDeploymentStep").addClass("is-active"),d=1;try{let{contract:m,transaction:r}=await U(a,t.address,l,C,e,7200);localStorage.setItem("pendingTransfer",JSON.stringify({HTLC_Address:m.address,secretHex:u,secretDigestHex:S,amount:l,recipientArchethic:n,HTLC_transaction:r})),localStorage.setItem("transferStep","deployedEthContract"),$("#ethDeploymentStep").removeClass("is-active");let f=m.address;$("#txSummary1Label").html(`Contract address on ${s}: <a href="${o}/address/${m.address}" target="_blank">${m.address}</a>`),$("#txSummary1").show(),await y("deployedEthContract",{HTLC_Contract:m,secretHex:u,secretDigestHex:S,amount:l,UCOPrice:c,ethChainId:i,recipientEthereum:a,recipientArchethic:n,unirisContract:t,signer:e,sourceChainExplorer:o,toChainExplorer:v,HTLC_transaction:r},c)}catch(m){k(m,d)}}async function y(e,t,a){switch(e){case"deployedEthContract":return e=2,t=await _(t),await y("transferedERC20",t,a);case"transferedERC20":return e=3,t=await P(t),await y("deployedArchethicContract",t,a);case"deployedArchethicContract":return e=4,$("#swapStep").addClass("is-active"),t=await J(t),await y("withdrawEthContract",t,a);case"withdrawEthContract":await R(t),$("#swapStep").removeClass("is-active"),$("#btnSwapSpinner").hide(),$("#btnSwap").prop("disabled",!1),$("#btnSwap").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),console.log("Token swap finish"),localStorage.removeItem("transferStep"),localStorage.removeItem("pendingTransfer"),setTimeout(async()=>{let i=await b(t.recipientArchethic)/1e8;$("#toBalanceUCO").text(parseFloat(i).toFixed(2)),$("#toBalanceUSD").text(a*i)},2e3);break}}})();
//# sourceMappingURL=app.js.map
