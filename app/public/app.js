(()=>{function _(){$("#main").hide(),$("#swapForm").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),j(),$("#error").text(""),$("#btnSwap").prop("disabled",!0),$("#btnSwap").text("Transfer"),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),$("#btnSwapSpinnerText").hide(),$("#infoRefund").hide(),J()}function P(){$("#connectionError").text("").hide(),$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),$("#swapForm").hide(),$("#main").show()}function E(t){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#connectionError").text(t).show()}function M(){j(),B(),$("#steps").hide(),J(),$("#error").text("")}function B(){$("#btnSwap").hide(),$("#btnSwapSpinner").prop("disabled",!0),$("#btnSwapSpinner").show(),$("#btnSwapSpinnerText").show(),$("#workflow").show(),$("#close").hide()}function j(){$("#txSummary1Label").text(""),$("#txSummary1").hide(),$("#txSummary2Label").text(""),$("#txSummary2").hide(),$("#txSummary2Timer").hide(),$("#txSummary3Label").text(""),$("#txSummary3").hide(),$("#txSummary4Label").text(""),$("#txSummary4").hide(),$("#txSummary5Label").text(""),$("#txSummary5").hide(),$("#txSummary6Label").text(""),$("#txSummary6").hide(),$("#txSummary7Label").text(""),$("#txSummary7").hide(),$("#txSummaryFinished").hide(),$("#txSummaryRefundFinished").hide(),$("#txRefundTransactionLabel").text(""),$("#txRefundTransaction").hide()}function J(){$("#ethDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").removeClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active"),$("#archethicDeploymentStep").removeClass("is-failed"),$("#swapStep").removeClass("is-active"),$("#swapStep").removeClass("is-failed")}function W(t,a,n){var r=$("<div></div>").html(a).dialog({title:t,resizable:!1,modal:!0,buttons:{Yes:function(){n(!0),$(this).dialog("close")},No:function(){n(!1),$(this).dialog("close")}},open:function(s,i){$(this).css({color:"white","font-family":"Lato","font-size":"12px",border:"none","border-radius":"10px","letter-spacing":"2.56232px"}),$(".ui-dialog").css({"border-radius":"20px"}),$(".ui-dialog-titlebar").css({background:"transparent",color:"white","font-family":"Lato","font-size":"14px",border:"none","border-radius":"10px 10px 0 0","letter-spacing":"2.56232px"}),$(".ui-widget-content").css({background:"#1a1a1a"}),$(".ui-dialog .ui-dialog-content").css({background:"transparent"}),$(".ui-dialog-buttonpane .ui-widget-content .ui-helper-clearfix").css({background:"transparent"}),$(".ui-dialog-buttonpane").css({background:"transparent"}),$(this).parent().find(".ui-dialog-buttonset button:first-child").css({"margin-right":"30px"}),$(this).parent().find(".ui-dialog-buttonset button").hover(function(){$(this).css({color:"#b0b0b0"})},function(){$(this).css({color:"white"})}),$(".ui-dialog-buttonpane button").css({background:"transparent",color:"white","font-family":"Lato","font-weight":"400","font-size":"14px",border:"none","border-radius":"10px","letter-spacing":"2.56232px"})}})}function z(t,a,n){var r=$("<input>").attr({type:"text",size:"50"}),s=$("<div>").html(a).append("<br/><br/>").append(r).dialog({title:t,resizable:!1,modal:!0,buttons:{Cancel:function(){n(!1),$(this).dialog("close")},Validate:function(){var i=r.val();ie(i)?(n(!0,i),$(this).dialog("close")):alert("Please enter a valid ERC20 address")}},open:function(i,o){r.css({"border-radius":"10px","font-family":"Lato","font-weight":"700","font-size":"14px","line-height":"17px",color:"#FFFFFF",border:"none",background:"#000000",padding:"10px","letter-spacing":"2.56232px"}),$(this).css({color:"white","font-family":"Lato","font-size":"12px",border:"none","border-radius":"10px","letter-spacing":"2.56232px"}),$(".ui-dialog").css({width:"450px","border-radius":"20px"}),$(".ui-dialog-titlebar").css({background:"transparent",color:"white","font-family":"Lato","font-size":"14px",border:"none","border-radius":"10px 10px 0 0","letter-spacing":"2.56232px"}),$(".ui-widget-content").css({background:"#1a1a1a"}),$(".ui-dialog .ui-dialog-content").css({background:"transparent"}),$(".ui-dialog-buttonpane .ui-widget-content .ui-helper-clearfix").css({background:"transparent"}),$(".ui-dialog-buttonpane").css({background:"transparent"}),$(this).parent().find(".ui-dialog-buttonset button:first-child").css({"margin-right":"30px"}),$(this).parent().find(".ui-dialog-buttonset button").hover(function(){$(this).css({color:"#b0b0b0"})},function(){$(this).css({color:"white"})}),$(".ui-dialog-buttonpane button").css({background:"transparent",color:"white","font-family":"Lato","font-weight":"400","font-size":"14px",border:"none","border-radius":"10px","letter-spacing":"2.56232px"})}})}function ie(t){return ethers.utils.isAddress(t)}async function V(t,a){let n=await pe();return new ethers.Contract(t,n,a)}async function A(t,a){let{abi:n}=await X();return new ethers.Contract(t,n,a)}async function q(t,a,n,r,s,i){let{abi:o,bytecode:c}=await X(),d=await new ethers.ContractFactory(o,c,s).deploy(t,a,ethers.utils.parseUnits(n,18),r,i,{gasLimit:1e6}),p=await d.deployTransaction.wait();return console.log("HTLC contract deployed at "+d.address),{contract:d,transaction:p}}async function ce(t,a,n,r){return await(await n.connect(r).transfer(a,ethers.utils.parseUnits(t,18))).wait()}async function G(t){let{HTLC_Contract:a,amount:n,unirisContract:r,signer:s,sourceChainExplorer:i}=t;$("#ethTransferStep").addClass("is-active");let o=await ce(n,a.address,r,s);localStorage.setItem("transferStep","transferedERC20");let c=localStorage.getItem("pendingTransfer"),h=JSON.parse(c);return h.erc20transferAddress=o.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(h)),console.log(`${n} UCO transfered`),$("#txSummary2Label").html(`Provision UCOs: <a href="${i}/tx/${o.transactionHash}" target="_blank">${o.transactionHash}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),t.erc20transferAddress=o.transactionHash,t}async function Q(t){let{HTLC_Contract:a,amount:n,secretDigestHex:r,recipientArchethic:s,ethChainId:i,toChainExplorer:o,HTLC_transaction:c}=t;$("#archethicDeploymentStep").addClass("is-active"),step=3;let h=await de(r,s,n,a.address,c.transactionHash,i);localStorage.setItem("transferStep","deployedArchethicContract");let d=localStorage.getItem("pendingTransfer"),p=JSON.parse(d);return p.archethicContractAddress=h,localStorage.setItem("pendingTransfer",JSON.stringify(p)),console.log("Contract address on Archethic",h),$("#txSummary3Label").html(`Contract address on Archethic: <a href="${o}/${h}" target="_blank">${h}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),t.archethicContractAddress=h,t}async function Y(t){let{HTLC_Contract:a,signer:n,secretHex:r,unirisContract:s,UCOPrice:i,sourceChainExplorer:o}=t,c=await le(a,n,r);localStorage.setItem("transferStep","withdrawEthContract");let h=localStorage.getItem("pendingTransfer"),d=JSON.parse(h);d.withdrawEthereumAddress=c.transactionHash,localStorage.setItem("pendingTransfer",JSON.stringify(d)),console.log(`Ethereum's withdraw transaction - ${c.transactionHash}`),$("#txSummary4Label").html(`${fromChainName} swap: <a href="${o}/tx/${c.transactionHash}" target="_blank">${c.transactionHash}</a>`),$("#txSummary4").show();let p=await n.getAddress(),u=await s.balanceOf(p),b=ethers.utils.formatUnits(u,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(b).toFixed(2)));let x=20/i;return $("#maxUCOValue").text(Math.min(b/i,x).toFixed(5)),$("#fromBalanceUSD").text((b*i).toFixed(5)),t.withdrawEthereumAddress=c.transactionHash,t}async function K({archethicContractAddress:t,HTLC_Contract:a,withdrawEthereumAddress:n,secretHex:r,ethChainId:s,toChainExplorer:i}){console.log(t);let{archethicWithdrawTransaction:o,archethicTransferTransaction:c}=await he(t,a.address,n,r,s);localStorage.setItem("transferStep","withdrawArchethicContract"),console.log(`Archethic's withdraw transaction ${o}`),console.log(`Archethic's transfer transaction ${c}`),$("#txSummary5Label").html(`Archethic swap: <a href="${i}/${o}" target="_blank">${o}</a>`),$("#txSummary5").show(),$("#txSummary6Label").html(`Archethic transfer: <a href="${i}/${c}" target="_blank">${c}</a>`),$("#txSummary6").show(),$("#txSummary2Timer").hide(),$("#txSummaryFinished").show()}async function de(t,a,n,r,s,i){return fetch("/swap/deployContract",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({secretHash:t,recipientAddress:a,amount:n*1e8,ethereumContractAddress:r,ethereumContractTransaction:s,ethereumChainId:i})}).then(T).then(o=>o.contractAddress)}async function le(t,a,n){let r=await t.connect(a);try{return await r.startTime(),await(await r.withdraw(`0x${n}`,{gasLimit:1e6})).wait()}catch(s){throw console.log(s),s}}async function he(t,a,n,r,s){return fetch("/swap/withdraw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({archethicContractAddress:t,ethereumContractAddress:a,ethereumWithdrawTransaction:n,secret:r,ethereumChainId:s})}).then(T).then(i=>{let{archethicWithdrawTransaction:o,archethicTransferTransaction:c}=i;return{archethicWithdrawTransaction:o,archethicTransferTransaction:c}})}async function pe(){return await(await fetch("uco_abi.json")).json()}async function X(){let a=await(await fetch("HTLC.json")).json();return{abi:a.abi,bytecode:a.bytecode}}async function Z(t){let a=await t.startTime(),n=await t.lockTime(),r=a.toNumber()+n.toNumber();return new Date(r*1e3)}async function F(t,a){let n=await t.connect(a);if(await n.finished())throw"Swap is already closed due to a withdraw or a prior refund.";return await(await n.refund()).wait()}async function k(t){return fetch(`/balances/archethic/${t}`).then(T).then(a=>a.balance)}async function L(t){return fetch("/status",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ethereumChainId:t})}).then(T).then(a=>{if(a.status!="ok")throw a.status;return{archethicEndpoint:a.archethicEndpoint,unirisTokenAddress:a.unirisTokenAddress,recipientEthereum:a.recipientEthereum,sufficientFunds:a.sufficientFunds,UCOPrice:a.UCOPrice,sourceChainExplorer:a.sourceChainExplorer,bridgeAddress:a.bridgeAddress,maxSwapDollar:a.maxSwapDollar}})}async function T(t){return new Promise(function(a,n){t.status>=200&&t.status<=299?t.json().then(a):t.json().then(n).catch(()=>n(t.statusText))})}var ee=[];for(let t=0;t<=255;++t){let a=t.toString(16).padStart(2,"0");ee.push(a)}function D(t){let a=new Uint8Array(t),n=new Array(a.length);for(let r=0;r<a.length;++r)n[r]=ee[a[r]];return n.join("")}async function I(t,a,n,r){$("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),console.log(t);let s=t;switch(t.data&&t.data.message?s=t.data.message:t.message&&(s=t.message),console.error(s),$("#error").text(`${s}`).show(),$("#close").show(),a){case 1:$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").addClass("is-failed"),$("#archethicDeploymentStep").addClass("is-failed"),$("#swapStep").addClass("is-failed");break;case 2:$("#ethTransferStep").addClass("is-failed"),$("#ethTransferStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;case 3:$("#archethicDeploymentStep").addClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed");break;case 4:$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed"),$("#archethicDeploymentStep").removeClass("is-active is-failed"),$("#swapStep").addClass("is-failed"),$("#swapStep").removeClass("is-active");break;default:break}if(console.log(n),n&&n.erc20transferAddress){let i=new ethers.providers.Web3Provider(window.ethereum),o=i.getSigner(),c=await A(n.HTLC_Address,i),h=await Z(c);me(h,c,o,n,r),$("#txSummary2Timer").show()}}function ue(t){var a=Date.parse(t)-Date.parse(new Date),n=Math.floor(a/1e3%60),r=Math.floor(a/1e3/60%60),s=Math.floor(a/(1e3*60*60)%24);return{total:a,hours:s,minutes:r,seconds:n}}function me(t,a,n,r,s){let i=setInterval(function(){var o=ue(t);o.total<=0?(clearInterval(i),$("#txSummary2Timer").html(`
        <img src="assets/images/icons/timer.png" height="20" alt="" style="padding-right: 5px; padding-bottom: 5px;" />
        As the transfer is not effective, you can retrieve your funds by clicking on the following button (fees not included).
        <button id="refundButton">REFUND</button>
        <button id="refundButtonSpinner" disabled style="display: none;">
						<span>REFUND</span>
						<span class="spinner-border spinner-border-sm" style="width: 8px; height: 8px; padding-bottom: 5px;" role="status" aria-hidden="true"></span>
				</button>
        <img src="assets/images/icons/help.png" height="20" alt="" style="padding-top: 3px; padding-left: 5px; padding-bottom: 5px; cursor: pointer;" onclick="window.open('https://wiki.archethic.net/FAQ/bridge/#what-happens-if-a-problem-occurs-or-i-refuse-a-transaction-during-the-transfer');" />
      `),$("#refundButton").on("click",async()=>{$("#error").text("").show(),$("#refundButton").hide(),$("#refundButtonSpinner").show(),setTimeout(function(){},2e3),F(a,n).then(async c=>{localStorage.removeItem("transferStep"),localStorage.removeItem("pendingTransfer"),$("#error").text("").show(),$("#txRefundTransactionLabel").html(`${r.sourceChainName} refund: <a href="${r.sourceChainExplorer}/tx/${c.transactionHash}" target="_blank">${c.transactionHash}</a>`),$("#txRefundTransaction").show(),$("#txSummaryRefundFinished").show(),$("#txSummary2Timer").hide(),$("#refundButtonSpinner").hide();let{UCOPrice:h}=await L(s),d=await r.signer.getAddress(),p=await r.unirisContract.balanceOf(d),u=ethers.utils.formatUnits(p,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(u).toFixed(8))),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((u*h).toFixed(5)))}).catch(c=>{$("#refundButton").show(),$("#refundButtonSpinner").hide(),$("#error").text(`${c.message||e}`).show()})})):$("#txSummary2Timer").html(`
        <img src="assets/images/icons/timer.png" height="20" alt="" style="padding-right: 5px; padding-bottom: 5px;" />
        As the transfer is not effective, you can retrieve your funds in ${("0"+o.hours).slice(-2)+"h"+("0"+o.minutes).slice(-2)+"m"+("0"+o.seconds).slice(-2)}.
        <img src="assets/images/icons/help.png" height="20" alt="" style="padding-left: 5px; padding-bottom: 5px; cursor: pointer;" onclick="window.open('https://wiki.archethic.net/FAQ/bridge/#what-happens-if-a-problem-occurs-or-i-refuse-a-transaction-during-the-transfer')" />
      `)},1e3)}function te(){localStorage.clear()}function H(){for(var t={},a=0;a<localStorage.length;a++){var n=localStorage.key(a);t[n]=localStorage.getItem(n)}var r=JSON.stringify(t),s=new Blob([r],{type:"application/json"}),i=URL.createObjectURL(s),o=$("<a />").attr("href",i).attr("download","localStorageData.json").appendTo("body");o[0].click(),o.remove(),URL.revokeObjectURL(i)}function ae(t){switch(t){case 80001:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Mumbai Polygon Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 137:sourceChainLogo="Polygon-logo.svg",fromChainName="Polygon",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Polygon Mainnet"),$("#toNetworkLabel").text("Archethic");break;case 97:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 56:sourceChainLogo="BSC-logo.svg",fromChainName="Binance",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("BSC Mainnet"),$("#toNetworkLabel").text("Archethic");break;case 5:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Goerli Ethereum Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 1337:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum Devnet"),$("#toNetworkLabel").text("Archethic Devnet");break;default:sourceChainLogo="Ethereum-logo.svg",fromChainName="Ethereum",$("#fromChain").text(fromChainName),$("#fromNetworkLabel").text("Ethereum Mainnet"),$("#toNetworkLabel").text("Archethic");break}return $("#sourceChainImg").attr("src",`assets/images/bc-logos/${sourceChainLogo}`),fromChainName}var w,ne;window.onload=async function(){try{if(typeof window.ethereum<"u")console.log("MetaMask is installed!"),localStorage.getItem("walletInjected?")&&(w=new ethers.providers.Web3Provider(window.ethereum),$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),await w.send("eth_requestAccounts",[]),oe(),await R());else throw"No ethereum provider is installed"}catch(t){localStorage.setItem("walletInjected?",!1),E(t.message||t)}};$("#connectMetamaskBtn").on("click",async()=>{w=new ethers.providers.Web3Provider(window.ethereum);try{$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),await w.send("eth_requestAccounts",[]),localStorage.setItem("walletInjected?",!0),oe(),await R()}catch(t){E(t.message||t)}});$("#clearLocalStorage").click(function(){return W("WARNING","Are you sure you want to clear the local data about the bridge?<br/><br/>If you have a transfer in progress, it will be lost and cannot be completed or refunded.",function(t){t&&(te(),$("#recipientAddress").val(""),$("#nbTokensToSwap").val(""),location.reload())}),!1});$("#exportLocalStorage").click(function(){H()});$("#exportLocalStorageModal").click(function(){H()});$("#exportLocalStorageModalRefund").click(function(){H()});$("#refund").click(function(){return z("Refund",`Please, fill your ${fromChainName} contract address to refund`,async function(t,a){if(t){var n=window.setInterval(function(){var r=$("#loading-dots");r.html().length>2?r.html(""):r.append(".")},500);try{$("#errorRefund").text(""),$("#refundFinished").hide(),$("#infoRefund").show(),$("#refundInProgress").show(),console.log("Refund contract",a);let r=await A(a,w),s=await F(r,N);$("#refundInProgress").hide(),$("#refundFinished").show(),console.log("Refund tx",s.transactionHash)}catch(r){$("#refundInProgress").hide();let s=r;r.data&&r.data.message?s=r.data.message:r.message&&(s=r.message),$("#errorRefund").text(`${s}`).show()}clearInterval(n)}}),!1});function oe(){w.provider.on("chainChanged",t=>{w=new ethers.providers.Web3Provider(window.ethereum),P(),clearInterval(ne),R().catch(a=>E(a.message||a))})}var O,S,m,N;async function R(){let{chainId:t}=await w.getNetwork();N=w.getSigner();let a=ae(t),{archethicEndpoint:n,unirisTokenAddress:r,recipientEthereum:s,sufficientFunds:i,UCOPrice:o,sourceChainExplorer:c,bridgeAddress:h,maxSwapDollar:d}=await L(t);m=o,_();let p=(d/o).toFixed(5);if($("#maxSwap").text(d),$("#nbTokensToSwap").attr("max",p),O=`${n}/explorer/transaction`,$("#ucoPrice").text(`1 UCO = ${o.toFixed(5)}$`).show(),$("#swapBalanceUSD").text(0),!i){$("#error").text("Bridge has insufficient funds. Please retry later..."),$("#workflow").show(),$("#close").css({visibility:"hidden"});return}console.log("Archethic endpoint: ",n);let u=await V(r,w),b=await N.getAddress(),x=await re(b,u,c,m,d);w.provider.on("accountsChanged",async l=>{let f=l[0];x=await re(f,u,c,m,d)}),ne=setInterval(async()=>{let{UCOPrice:l}=await L(t);if(l!=m){$("#ucoPrice").text(`1 UCO = ${l.toFixed(5)}$`).show();let f=(d/l).toFixed(5);$("#nbTokensToSwap").attr("max",f);let C=parseFloat($("#fromBalanceUCO").text()),se=(C*l).toFixed(5);$("#fromBalanceUSD").text(new Intl.NumberFormat(se)),$("#maxUCOValue").attr("value",Math.min(C,f).toFixed(5)),m=l}},5e3),$("#recipientAddress").on("change",async l=>{let C=await k($(l.target).val())/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(C).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((m*C).toFixed(5))),$("#btnSwap").prop("disabled",!1)}),$("#recipientAddress").focus(),$("#nbTokensToSwap").on("input",l=>{let f=$(l.target).val();$("#swapBalanceUSD").text((f*m).toFixed(5))}),$("#maxButton").on("click",()=>{let l=$("#maxUCOValue").val();$("#nbTokensToSwap").val(l),$("#swapBalanceUSD").text((l*m).toFixed(5))}),$("#close").on("click",()=>{$("#workflow").hide()}),$("#closeInfoRefund").on("click",()=>{$("#infoRefund").hide()});let y=localStorage.getItem("pendingTransfer"),g;y&&(g=await $e(y,t,u,O,s,N)),$("#swapForm").on("submit",async l=>{if(l.preventDefault(),!l.target.checkValidity())return;if($("#error").text(""),g){B();try{await v(localStorage.getItem("transferStep"),g)}catch(C){I(C,S,JSON.parse(y,t))}return}let f=$("#recipientAddress").val();await fe(N,u,s,f,t,c,h,a,x)})}async function re(t,a,n,r,s){let i=t;t.length>4&&(i=t.substring(0,5)+"..."+t.substring(t.length-3)),$("#accountName").html(`Account<br><a href="${n}/address/${t}" target="_blank">${i}</a>`);let o=(s/r).toFixed(5),c=await U(t,a,r);return $("#maxUCOValue").attr("value",Math.min(c,o).toFixed(5)),c}async function U(t,a,n){let r=await a.balanceOf(t),s=ethers.utils.formatUnits(r,18);return $("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(s).toFixed(8))),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((s*n).toFixed(5))),s}async function fe(t,a,n,r,s,i,o,c,h){M(),S=0;let d=$("#nbTokensToSwap").val();if(h*1e18<d*1e18){$("#btnSwapSpinner").hide(),$("#btnSwap").show(),$("#btnSwap").prop("disabled",!1),$("#error").text(`Insufficient UCO on ${c}`),$("#close").show();return}if(await k(o)<=d*1e8){$("#error").text("Bridge has insuffficient funds. Please retry later..."),$("#close").show();return}$("#steps").show();let u=new Uint8Array(32);crypto.getRandomValues(u);let b=D(u),x=await crypto.subtle.digest("SHA-256",u);x=new Uint8Array(x);let y=D(x);$("#ethDeploymentStep").addClass("is-active"),S=1;try{let{contract:g,transaction:l}=await q(n,a.address,d,x,t,7200);localStorage.setItem("pendingTransfer",JSON.stringify({HTLC_Address:g.address,secretHex:b,secretDigestHex:y,amount:d,recipientArchethic:r,HTLC_transaction:l,sourceChainName:c,sourceChainExplorer:i})),localStorage.setItem("transferStep","deployedEthContract"),$("#ethDeploymentStep").removeClass("is-active"),$("#txSummary1Label").html(`Contract address on ${c}: <a href="${i}/address/${g.address}" target="_blank">${g.address}</a>`),$("#txSummary1").show(),await v("deployedEthContract",{HTLC_Contract:g,secretHex:b,secretDigestHex:y,amount:d,ethChainId:s,recipientEthereum:n,recipientArchethic:r,unirisContract:a,signer:t,sourceChainExplorer:i,toChainExplorer:O,HTLC_transaction:l,sourceChainName:c})}catch(g){let l=localStorage.getItem("pendingTransfer"),f=JSON.parse(l);I(g,S,f,s)}}async function v(t,a){switch(t){case"deployedEthContract":return t=2,a=await G(a),U(await a.signer.getAddress(),a.unirisContract,m),await v("transferedERC20",a);case"transferedERC20":return t=3,a=await Q(a),await v("deployedArchethicContract",a);case"deployedArchethicContract":return t=4,$("#swapStep").addClass("is-active"),a=await Y(a),await v("withdrawEthContract",a);case"withdrawEthContract":await K(a),$("#swapStep").removeClass("is-active"),$("#btnSwapSpinner").hide(),$("#btnSwap").prop("disabled",!1),$("#btnSwap").show(),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#close").show(),console.log("Token swap finish"),localStorage.removeItem("transferStep"),localStorage.removeItem("pendingTransfer"),$("#recipientAddress").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),U(await a.signer.getAddress(),a.unirisContract,m),setTimeout(async()=>{let r=await k(a.recipientArchethic)/1e8;$("#toBalanceUCO").text(parseFloat(r).toFixed(2)),$("#toBalanceUSD").text((m*r).toFixed(5))},2e3);break}}async function $e(t,a,n,r,s,i){$("#btnSwapSpinnerText").text("Loading previous transfer"),$("#btnSwapSpinner").show(),$("#btnSwap").hide();let o=JSON.parse(t),c={HTLC_Contract:await A(o.HTLC_Address,w),HTLC_transaction:o.HTLC_transaction,secretHex:o.secretHex,secretDigestHex:o.secretDigestHex,amount:o.amount,ethChainId:a,recipientEthereum:s,recipientArchethic:o.recipientArchethic,unirisContract:n,signer:i,erc20transferAddress:o.erc20transferAddress,archethicContractAddress:o.archethicContractAddress,withdrawEthereumAddress:o.withdrawEthereumAddress,sourceChainExplorer:o.sourceChainExplorer,toChainExplorer:r,sourceChainName:o.sourceChainName};$("#recipientAddress").val(o.recipientArchethic),$("#recipientAddress").prop("disabled",!0),$("#nbTokensToSwap").val(o.amount),$("#nbTokensToSwap").prop("disabled",!0);let d=await k(o.recipientArchethic)/1e8;switch($("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(d).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((m*d).toFixed(5))),$("#swapBalanceUSD").text((o.amount*m).toFixed(5)),$("#ethDeploymentStep").removeClass("is-active is-failed"),$("#txSummary1Label").html(`Contract address on ${o.sourceChainName}: <a href="${o.sourceChainExplorer}/address/${o.HTLC_Address}" target="_blank">${o.HTLC_Address}</a>`),$("#txSummary1").show(),$("#ethTransferStep").addClass("is-active"),S=2,o.erc20transferAddress&&(S=3,$("#txSummary2Label").html(`Provision UCOs: <a href="${o.sourceChainExplorer}/tx/${o.erc20transferAddress}" target="_blank">${o.erc20transferAddress}</a>`),$("#txSummary2").show()),o.archethicContractAddress&&(S=4,$("#txSummary3Label").html(`Contract address on Archethic: <a href="${r}/${o.archethicContractAddress}" target="_blank">${o.archethicContractAddress}</a>`),$("#txSummary3").show()),o.withdrawEthereumAddress&&($("#txSummary4Label").html(`${fromChainName} swap: <a href="${o.sourceChainExplorer}/tx/${o.withdrawEthereumAddress}" target="_blank">${o.withdrawEthereumAddress}</a>`),$("#txSummary4").show()),$("#btnSwapSpinner").hide(),$("#btnSwap").show(),$("#btnSwap").prop("disabled",!1),S){case 2:$("#ethTransferStep").addClass("is-active"),$("#ethTransferStep").removeClass("is-failed"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;case 3:$("#archethicDeploymentStep").addClass("is-active"),$("#archethicDeploymentStep").removeClass("is-failed"),$("#ethDeploymentStep").removeClass("is-failed is-active"),$("#ethTransferStep").removeClass("is-failed is-active");break;case 4:$("#swapStep").addClass("is-active"),$("#swapStep").removeClass("is-failed"),$("#archethicDeploymentStep").removeClass("is-active is-failed"),$("#ethTransferStep").removeClass("is-active is-failed"),$("#ethDeploymentStep").removeClass("is-active is-failed");break;default:break}$("#steps").show(),B();try{await v(localStorage.getItem("transferStep"),c)}catch(p){I(p,S,JSON.parse(t,a))}return c}})();
//# sourceMappingURL=app.js.map
