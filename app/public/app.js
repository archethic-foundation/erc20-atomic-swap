(()=>{window.onload=async function(){if(typeof window.ethereum<"u")console.log("MetaMask is installed!");else throw"No ethereum provider is installed"};$("#connectMetamaskBtn").on("click",async()=>{try{$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),provider=new ethers.providers.Web3Provider(window.ethereum),await provider.send("eth_requestAccounts",[]),await D(provider)}catch(t){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#error").text(`${t.message||t}`).show()}});var k,s;async function D(t){let{chainId:e}=await t.getNetwork(),n=t.getSigner(),a;switch(e){case 80001:a="Polygon-logo.svg",s="Polygon",$("#fromChain").text(s),$("#fromNetworkLabel").text("Mumbai Polygon Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 137:a="Polygon-logo.svg",s="Polygon",$("#fromChain").text(s),$("#fromNetworkLabel").text("Polygon"),$("#toNetworkLabel").text("Archethic");break;case 97:a="BSC-logo.svg",s="Binance",$("#fromChain").text(s),$("#fromNetworkLabel").text("BSC Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 56:a="BSC-logo.svg",s="Binance",$("#fromChain").text(s),$("#fromNetworkLabel").text("BSC"),$("#toNetworkLabel").text("Archethic");break;case 5:a="Ethereum-logo.svg",s="Ethereum",$("#fromChain").text(s),$("#fromNetworkLabel").text("Goerli Ethereum Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 1337:a="Ethereum-logo.svg",s="Ethereum",$("#fromChain").text(s),$("#fromNetworkLabel").text("Ethereum Devnet"),$("#toNetworkLabel").text("Archethic Devnet");break;default:a="Ethereum-logo.svg",fromChain="Ethereum",$("#fromChain").text(s),$("#fromNetworkLabel").text("Ethereum"),$("#toNetworkLabel").text("Archethic");break}$("#sourceChainImg").attr("src",`assets/images/bc-logos/${a}`);let{archethicEndpoint:o,unirisTokenAddress:c,recipientEthereum:i,sufficientFunds:l,UCOPrice:d,sourceChainExplorer:h,bridgeAddress:v}=await W(e);$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#main").hide(),$("#swapForm").show();let p=20/d;if($("#nbTokensToSwap").attr("max",p),k=`${o}/explorer/transaction`,$("#ucoPrice").text(`1 UCO = ${d.toFixed(5)}$`).show(),$("#swapBalanceUSD").text(0),!l){$("#error").text("Bridge has insuffficient funds. Please retry later.");return}console.log("Archethic endpoint: ",o);let b=await n.getAddress(),u=await E(c,t),g=await u.balanceOf(b),m=ethers.utils.formatUnits(g,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(m).toFixed(8))),$("#maxUCOValue").text(Math.min(m/d,p).toFixed(5)),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((m*d).toFixed(5))),$("#recipientAddress").on("change",async r=>{let f=await A($(r.target).val())/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(f).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((d*f).toFixed(5))),$("#btnSwap").prop("disabled",!1)}),$("#recipientAddress").focus(),$("#nbTokensToSwap").on("change",r=>{let w=$(r.target).val();$("#swapBalanceUSD").text((w*d).toFixed(5))}),$("#swapForm").on("submit",async r=>{if(r.preventDefault(),!r.target.checkValidity())return;let w=$("#recipientAddress").val();await O(n,u,i,w,e,archethic,d,h,v)})}async function E(t,e){let n=await R();return new ethers.Contract(t,n,e)}async function O(t,e,n,a,o,c,i,l,d){let h=$("#nbTokensToSwap").val();if($("#btnSwap").prop("disabled",!0),$("#nbTokensToSwap").prop("disabled",!0),$("#recipientAddress").prop("disabled",!0),$("#btnSwap").hide(),$("#btnSwapSpinner").show(),await A(d)<=h*1e9){$("#error").text("Bridge has insuffficient funds. Please retry later.");return}$("#steps").show(),$("#txSummary").hide();let p=new Uint8Array(32);crypto.getRandomValues(p);let b=L(p),u=await crypto.subtle.digest("SHA-256",p);u=new Uint8Array(u);let g=L(u);$("#ethDeploymentStep").addClass("is-active");try{let r=await j(n,e.address,h,u,t,7200);var m=1;$("#ethDeploymentStep").removeClass("is-active"),$("#txSummary").show();let w=r.address;$("#txSummary1Label").html(`Contract address on ${s}: <a href="${l}/address/${r.address}" target="_blank">${r.address}</a>`),$("#txSummary1").show(),$("#ethTransferStep").addClass("is-active"),m=2;let f=await _(h,w,e,t);console.log(`${h} UCO transfered`),$("#txSummary2Label").html(`Provision UCO: <a href="${l}/tx/${f.transactionHash}" target="_blank">${f.transactionHash}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),$("#archethicDeploymentStep").addClass("is-active"),m=3;let x=await P(g,a,h,w,o);console.log("Contract address on Archethic",x),$("#txSummary3Label").html(`Contract address on Archethic : <a href="${k}/${x}" target="_blank">${x}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),$("#swapStep").addClass("is-active"),m=4;let y=await I(r,t,b);console.log(`Ethereum's withdraw transaction - ${y.transactionHash}`),$("#txSummary4Label").html(`${s} swap: <a href="${l}/tx/${y.transactionHash}" target="_blank">${y.transactionHash}</a>`),$("#txSummary4").show();let N=await t.getAddress(),U=await e.balanceOf(N),C=ethers.utils.formatUnits(U,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(C).toFixed(2)));let H=20/i;$("#maxUCOValue").text(Math.min(C/i,H).toFixed(5)),$("#fromBalanceUSD").text(C*i);let T=await M(x,w,y.transactionHash,b,o);console.log(`Archethic's withdraw transaction ${T}`),$("#txSummary5Label").html(`Archethic swap : <a href="${k}/${T}" target="_blank">${T}</a>`),$("#txSummary5").show(),$("#swapStep").removeClass("is-active"),console.log("Token swap finish");let B=await A(a)/1e8;$("#toBalanceUCO").text(parseFloat(B).toFixed(2)),$("#toBalanceUSD").text(i*B),$("#txSummary").show(),$("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide()}catch(r){switch(console.error(r.message||r),$("#error").text(`${r.message||r}`).show(),$("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide(),m){case 1:$("#ethDeploymentStep").removeClass("is-active"),$("#ethDeploymentStep").addClass("is-error");break;case 2:$("#ethTransferStep").removeClass("is-active"),$("#ethTransferStep").addClass("is-error");break;case 3:$("#archethicDeploymentStep").removeClass("is-active"),$("#archethicDeploymentStep").addClass("is-error");break;case 4:$("#swapStep").removeClass("is-active"),$("#swapStep").addClass("is-error");break;default:break}}}async function P(t,e,n,a,o){let c=new Date;c.setSeconds(c.getSeconds()+1e4);let i=Math.floor(c/1e3);return fetch("/swap/deployContract",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({secretHash:t,recipientAddress:e,amount:n*1e8,endTime:i,ethereumContractAddress:a,ethereumChainId:o})}).then(S).then(l=>l.contractAddress)}async function I(t,e,n){return await(await(await t.connect(e)).withdraw(`0x${n}`,{gasLimit:1e7})).wait()}async function M(t,e,n,a,o){return fetch("/swap/withdraw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({archethicContractAddress:t,ethereumContractAddress:e,ethereumWithdrawTransaction:n,secret:a,ethereumChainId:o})}).then(S).then(c=>{let{archethicWithdrawTransaction:i}=c;return i})}async function j(t,e,n,a,o,c){let{abi:i,bytecode:l}=await V(),h=await new ethers.ContractFactory(i,l,o).deploy(t,e,ethers.utils.parseUnits(n,18),a,c,{gasLimit:1e6});return await h.deployTransaction.wait(),console.log("HTLC contract deployed at "+h.address),h}async function _(t,e,n,a){return await(await n.connect(a).transfer(e,ethers.utils.parseUnits(t,18))).wait()}var F=[];for(let t=0;t<=255;++t){let e=t.toString(16).padStart(2,"0");F.push(e)}function L(t){let e=new Uint8Array(t),n=new Array(e.length);for(let a=0;a<e.length;++a)n[a]=F[e[a]];return n.join("")}async function W(t){return fetch("/status",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ethereumChainId:t})}).then(S).then(e=>{if(e.status!="ok")throw e.status;return{archethicEndpoint:e.archethicEndpoint,unirisTokenAddress:e.unirisTokenAddress,recipientEthereum:e.recipientEthereum,sufficientFunds:e.sufficientFunds,UCOPrice:e.UCOPrice,sourceChainExplorer:e.sourceChainExplorer,bridgeAddress:e.bridgeAddress}})}async function R(){return await(await fetch("uco_abi.json")).json()}async function V(){let e=await(await fetch("HTLC.json")).json();return{abi:e.abi,bytecode:e.bytecode}}async function S(t){return new Promise(function(e,n){t.status>=200&&t.status<=299?t.json().then(e):t.json().then(n).catch(()=>n(t.statusText))})}async function A(t){return fetch(`/balances/archethic/${t}`).then(S).then(e=>e.balance)}})();
//# sourceMappingURL=app.js.map
