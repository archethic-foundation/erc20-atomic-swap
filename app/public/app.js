(()=>{window.onload=async function(){if(typeof window.ethereum<"u")console.log("MetaMask is installed!");else throw"No ethereum provider is installed"};$("#connectMetamaskBtn").on("click",async()=>{try{$("#connectMetamaskBtn").hide(),$("#connectMetamaskBtnSpinner").show(),provider=new ethers.providers.Web3Provider(window.ethereum),await provider.send("eth_requestAccounts",[]),await H(provider)}catch(e){$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#error").text(`An error occured: ${e.message||e}`).show()}});var T,r;async function H(e){let{chainId:t}=await e.getNetwork(),n=e.getSigner(),a;switch(t){case 80001:a="Polygon-logo.svg",r="Polygon",$("#fromChain").text(r),$("#fromNetworkLabel").text("Mumbai Polygon Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 137:a="Polygon-logo.svg",r="Polygon",$("#fromChain").text(r),$("#fromNetworkLabel").text("Polygon"),$("#toNetworkLabel").text("Archethic");break;case 97:a="BSC-logo.svg",r="Binance",$("#fromChain").text(r),$("#fromNetworkLabel").text("BSC Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 56:a="BSC-logo.svg",r="Binance",$("#fromChain").text(r),$("#fromNetworkLabel").text("BSC"),$("#toNetworkLabel").text("Archethic");break;case 5:a="Ethereum-logo.svg",r="Ethereum",$("#fromChain").text(r),$("#fromNetworkLabel").text("Goerli Ethereum Testnet"),$("#toNetworkLabel").text("Archethic Testnet");break;case 1337:a="Ethereum-logo.svg",r="Ethereum",$("#fromChain").text(r),$("#fromNetworkLabel").text("Ethereum Devnet"),$("#toNetworkLabel").text("Archethic Devnet");break;default:a="Ethereum-logo.svg",fromChain="Ethereum",$("#fromChain").text(r),$("#fromNetworkLabel").text("Ethereum"),$("#toNetworkLabel").text("Archethic");break}$("#sourceChainImg").attr("src",`assets/images/bc-logos/${a}`);let{archethicEndpoint:o,unirisTokenAddress:i,recipientEthereum:c,sufficientFunds:m,UCOPrice:d,sourceChainExplorer:h,bridgeAddress:k}=await _(t);$("#connectMetamaskBtnSpinner").hide(),$("#connectMetamaskBtn").show(),$("#main").hide(),$("#swapForm").show();let f=20/d;if($("#nbTokensToSwap").attr("max",f),T=`${o}/explorer/transaction`,$("#ucoPrice").text(`1 UCO = ${d.toFixed(5)}$`).show(),$("#swapBalanceUSD").text(0),!m){$("#error").text("An error occured: Bridge has insuffficient funds. Please retry later");return}console.log("Archethic endpoint: ",o);let b=await n.getAddress(),u=await E(i,e),y=await u.balanceOf(b),s=ethers.utils.formatUnits(y,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(s).toFixed(8))),$("#maxUCOValue").text(Math.min(s/d,f).toFixed(5)),$("#fromBalanceUSD").text(new Intl.NumberFormat().format((s*d).toFixed(5))),$("#recipientAddress").on("change",async l=>{let p=await A($(l.target).val())/1e8;$("#toBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(p).toFixed(8))),$("#toBalanceUSD").text(new Intl.NumberFormat().format((d*p).toFixed(5))),$("#btnSwap").prop("disabled",!1)}),$("#recipientAddress").focus(),$("#nbTokensToSwap").on("change",l=>{let w=$(l.target).val();$("#swapBalanceUSD").text((w*d).toFixed(5))}),$("#swapForm").on("submit",async l=>{if(l.preventDefault(),!l.target.checkValidity())return;let w=$("#recipientAddress").val();await O(n,u,c,w,t,archethic,d,h,k)})}async function E(e,t){let n=await W();return new ethers.Contract(e,n,t)}async function O(e,t,n,a,o,i,c,m,d){let h=$("#nbTokensToSwap").val();if($("#btnSwap").prop("disabled",!0),$("#nbTokensToSwap").prop("disabled",!0),$("#recipientAddress").prop("disabled",!0),$("#btnSwap").hide(),$("#btnSwapSpinner").show(),await A(d)<=h*1e9){$("#error").text("An error occured: Bridge has insuffficient funds. Please retry later");return}$("#steps").show(),$("#txSummary").hide();let f=new Uint8Array(32);crypto.getRandomValues(f);let b=L(f),u=await crypto.subtle.digest("SHA-256",f);u=new Uint8Array(u);let y=L(u);$("#ethDeploymentStep").addClass("is-active");try{let s=await M(n,t.address,h,u,e,7200);$("#ethDeploymentStep").removeClass("is-active"),$("#txSummary").show();let l=s.address;$("#txSummary1Label").html(`Contract address on ${r}: <a href="${m}/address/${s.address}" target="_blank">${s.address}</a>`),$("#txSummary1").show(),$("#ethTransferStep").addClass("is-active");let w=await j(h,l,t,e);console.log(`${h} UCO transfered`),$("#txSummary2Label").html(`Provision UCO: <a href="${m}/tx/${w.transactionHash}" target="_blank">${w.transactionHash}</a>`),$("#txSummary2").show(),$("#ethTransferStep").removeClass("is-active"),$("#archethicDeploymentStep").addClass("is-active");let p=await D(y,a,h,l,o);console.log("Contract address on Archethic",p),$("#txSummary3Label").html(`Contract address on Archethic : <a href="${T}/${p}" target="_blank">${p}</a>`),$("#txSummary3").show(),$("#archethicDeploymentStep").removeClass("is-active"),$("#swapStep").addClass("is-active");let x=await P(s,e,b);console.log(`Ethereum's withdraw transaction - ${x.transactionHash}`),$("#txSummary4Label").html(`${r} swap: <a href="${m}/tx/${x.transactionHash}" target="_blank">${x.transactionHash}</a>`),$("#txSummary4").show();let F=await e.getAddress(),N=await t.balanceOf(F),S=ethers.utils.formatUnits(N,18);$("#fromBalanceUCO").text(new Intl.NumberFormat().format(parseFloat(S).toFixed(2)));let U=20/c;$("#maxUCOValue").text(Math.min(S/c,U).toFixed(5)),$("#fromBalanceUSD").text(S*c);let C=await I(p,l,x.transactionHash,b,o);console.log(`Archethic's withdraw transaction ${C}`),$("#txSummary5Label").html(`Archethic swap : <a href="${T}/${C}" target="_blank">${C}</a>`),$("#txSummary5").show(),$("#swapStep").removeClass("is-active"),console.log("Token swap finish");let B=await A(a)/1e8;$("#toBalanceUCO").text(parseFloat(B).toFixed(2)),$("#toBalanceUSD").text(c*B),$("#txSummary").show(),$("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide()}catch(s){console.error(s.message||s),$("#error").text(`An error occured: ${s.message||s}`).show(),$("#btnSwap").prop("disabled",!1),$("#nbTokensToSwap").prop("disabled",!1),$("#recipientAddress").prop("disabled",!1),$("#btnSwap").show(),$("#btnSwapSpinner").hide()}}async function D(e,t,n,a,o){let i=new Date;i.setSeconds(i.getSeconds()+1e4);let c=Math.floor(i/1e3);return fetch("/swap/deployContract",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({secretHash:e,recipientAddress:t,amount:n*1e8,endTime:c,ethereumContractAddress:a,ethereumChainId:o})}).then(g).then(m=>m.contractAddress)}async function P(e,t,n){return await(await(await e.connect(t)).withdraw(`0x${n}`,{gasLimit:1e7})).wait()}async function I(e,t,n,a,o){return fetch("/swap/withdraw",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify({archethicContractAddress:e,ethereumContractAddress:t,ethereumWithdrawTransaction:n,secret:a,ethereumChainId:o})}).then(g).then(i=>{let{archethicWithdrawTransaction:c}=i;return c})}async function M(e,t,n,a,o,i){let{abi:c,bytecode:m}=await R(),h=await new ethers.ContractFactory(c,m,o).deploy(e,t,ethers.utils.parseUnits(n,18),a,i,{gasLimit:1e6});return await h.deployTransaction.wait(),console.log("HTLC contract deployed at "+h.address),h}async function j(e,t,n,a){return await(await n.connect(a).transfer(t,ethers.utils.parseUnits(e,18))).wait()}var v=[];for(let e=0;e<=255;++e){let t=e.toString(16).padStart(2,"0");v.push(t)}function L(e){let t=new Uint8Array(e),n=new Array(t.length);for(let a=0;a<t.length;++a)n[a]=v[t[a]];return n.join("")}async function _(e){return fetch("/status",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({ethereumChainId:e})}).then(g).then(t=>{if(t.status!="ok")throw t.status;return{archethicEndpoint:t.archethicEndpoint,unirisTokenAddress:t.unirisTokenAddress,recipientEthereum:t.recipientEthereum,sufficientFunds:t.sufficientFunds,UCOPrice:t.UCOPrice,sourceChainExplorer:t.sourceChainExplorer,bridgeAddress:t.bridgeAddress}})}async function W(){return await(await fetch("uco_abi.json")).json()}async function R(){let t=await(await fetch("HTLC.json")).json();return{abi:t.abi,bytecode:t.bytecode}}async function g(e){return new Promise(function(t,n){e.status>=200&&e.status<=299?e.json().then(t):e.json().then(n).catch(()=>n(e.statusText))})}async function A(e){return fetch(`/balances/archethic/${e}`).then(g).then(t=>t.balance)}})();
//# sourceMappingURL=app.js.map
